
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="https://cesiumjs.org/Cesium/Build/Cesium/Cesium.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cesiumjs.org/Cesium/Build/Cesium/Widgets/widgets.css">
  <style type="text/css">
          html, #cesiumContainer {
          height: 100%;
      }
      body {
          padding: 0;
          margin: 0;
          overflow: hidden;
          height: 100%;
      }
  </style>

  <title>Telemetry</title>

<script type='text/javascript'>//<![CDATA[
window.onload=function(){
var viewer = new Cesium.Viewer('cesiumContainer',{
//	sceneMode : Cesium.SceneMode.COLUMBUS_VIEW
});
window.viewer=viewer;
var camera = viewer.scene.camera;

viewer.scene.preRender.addEventListener(function() {
return;
	//lock north
    camera.setView({
        orientation: {
            heading: 0,
            pitch: camera.pitch,
            roll: camera.roll
        }
    });
});

/*viewer.terrainProvider = new Cesium.CesiumTerrainProvider({
    url : 'https://assets.agi.com/stk-terrain/world',
    requestWaterMask : true, // required for water effects
    requestVertexNormals : true // required for terrain lighting
});*/


 //viewer.scene.morphToColumbusView();
    /*viewer.camera.flyTo({
        destination : Cesium.Cartesian3.fromDegrees(-117.16, 32.71, 15000.0)
    });*/
	
	var position = Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 5.0);
    var heading = Cesium.Math.toRadians(135);
    var pitch = 0;
    var roll = 0;
    var hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
    var orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);

    var entity = viewer.entities.add({
        name : 'mavic.glb',
        position : position,
        orientation : orientation,
        model : {
            uri :  '/Cesium_Air.glb',
            minimumPixelSize : 1280,
            maximumScale : 20000,
			scale : 10.0
        }
    });
    viewer.trackedEntity = entity;
	
	
};

function createModel(url, height) {
    viewer.entities.removeAll();

    var position = Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, height);
    var heading = Cesium.Math.toRadians(135);
    var pitch = 0;
    var roll = 0;
    var hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
    var orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);

    var entity = viewer.entities.add({
        name : url,
        position : position,
        orientation : orientation,
        model : {
            uri : url,
            minimumPixelSize : 128,
            maximumScale : 20000
        }
    });
    viewer.trackedEntity = entity;
}
//createModel('/mavic.glb', 5000.0);
</script>

  
</head>

<body>
  <div id="cesiumContainer"></div>
<section id = "wrapper">
            <style>
               #wrapper {
			   position:absolute;
			   bottom:30px;
			   right:10px;
                  width: 22%;
                  height: 50%;
                  margin: 0 auto;
                  background: #333232bd;
			    color:lightcyan;
                  border-radius: 10px;
                  border-top: 1px solid #fff;
                  padding-bottom: 16px;
               }
               #status-panel {
                  position:absolute;
                  width:30%;
                  height:95%;
                  top:30px;
                  left:10px;
                  background: #333232bd;
				color:lightcyan;
                  border-radius: 10px;
                  border-top: 1px solid #fff;
				  overflow:auto;
               }		
               #status-panel table {
			   width:100%;
			   height:100%;
			   }
               .preview {
                  position:absolute;
                  width:640px;
                  height:360px;
                  top:20px;
                  right:20px;
				  background:blue;
               }			   
               #chat { width: 97%; }
               .message { font-weight: bold; }
               .message:before { content: ' '; color: #bbb; font-size: 14px; }
               #log {
                  overflow: auto;
                  height: 92%;
                  list-style: none;
                  padding-left: 4px;
               }
               #log li {
                  margin: 0;
//                  padding: 10px 0;
               }
					
               body {
                  font: normal 12px/14px "Helvetica Neue", Helvetica, sans-serif;
                  background: rgb(237, 237, 236);
                  margin: 0;
//                  margin-top: 40px;
                  padding: 0;
               }
               section, header {
                  display: block;
               }

               h1 {
//                  padding-top: 10px;
               }
               h2 {
                  font-size: 100%;
                  font-style: italic;
               }
              article  {
                  height: 100%;
               }
               #status {
                  padding: 5px;
                  color: #fff;
                  background: #ccc;
               }
               #status.fail {
                  background: #c00;
               }
               #status.success {
                  background: #0c0;
               }
               #status.offline {
                  background: #c00;
               }
               #status.online {
                  background: #0c0;
               }

              .cesium-viewer-bottom,  .cesium-viewer-animationContainer, .cesium-viewer-timelineContainer{
                  display: none;
               }		
              .cesium-viewer-toolbar{
                  z-index: 2;
               }					   

            </style>
				
            <article>
               <p id = "status">Not connected</p>
               <ul id = "log"></ul>
            </article>
	

            <script>
			//<form onsubmit = "addMessage(); return false;">
                //<input type = "text" id = "chat" placeholder = "Send Command (not working yet)" />
               //</form>
               //form = chat.form;
			   
               connected = document.getElementById("connected");
               log = document.getElementById("log");
               chat = document.getElementById("chat");
               state = document.getElementById("status");
               
					
               if (window.WebSocket === undefined) {
                  state.innerHTML = "sockets not supported";
                  state.className = "fail";
               }else {
                  if (typeof String.prototype.startsWith != "function") {
                     String.prototype.startsWith = function (str) {
                        return this.indexOf(str) == 0;
                     };
                  }
                  window.addEventListener("load", doConnect, false);
               }
					
               function doConnect() {
			   //var ip = "ws://"+ window.location.host+":3001";
 //                 var wsUri = "ws://"+ window.location.hostname+":3001";
                  var wsUri = "ws://192.168.1.8:3001";
                  websocket = new WebSocket(wsUri);
                  websocket.onopen = function(evt) { onOpen(evt) };
                  websocket.onclose = function(evt) { onClose(evt) };
                  websocket.onmessage = function(evt) { onMessage(evt) };
                  websocket.onerror = function(evt) { onError(evt) };
               }
			   window.dodoConnect=doConnect;
					
               function onOpen(evt) {
                  state.className = "success";
                  state.innerHTML = "Connected to server";
               }
					
               function onClose(evt) {
                  state.className = "fail";
                  state.innerHTML = "Not connected";
                  connected.innerHTML = "0";
               }
			
			
               function onMessage(evt) {
			     var str = evt.data.substring(22)
				 if(str.startsWith("GET:") || str.startsWith("PSH:"))
				 {
					var exp = str.substring(4);
					var parts=exp.split("=");
					var controllerName = parts[0].split(".")[0];
					var keyName = parts[0].split(".")[1];
					var keyValue = parts[1];
					var e = $('*[data-id="'+controllerName+'-'+keyName+'"]')
					if( e.length==0)
					{
						$("table#telemetry").append("<tr data-id="+controllerName+"-"+keyName+"><td>"+controllerName+"."+keyName+"</td><td>"+keyValue+"</td></tr>");
					}else
						e.find("td").eq(1).html(keyValue); 
					
					return;//dont display in log.
				 }
				//add to log window.
				 log.innerHTML = log.innerHTML+'<li class = "message">' + 
					evt.data.substring(9) + "</li>" ;//note substring cuts off date part of timestamp for brevity.
				log.scrollTop = log.scrollHeight;
return;

				var msg = evt.data.split(" ")[2];
				
				if(msg.indexOf(":")>0)//system message?
				{
					var parts =msg.split(":");
					var system = parts[0];
					
					parts =  parts[1].split("=");
					var name = parts[0];
					var value = parts[1];
					var e =$("#"+system+"-"+name);
					if(e.length==0)
					{
						$("table#telemetry").append("<tr id="+system+"-"+name+"><td>"+name+"</td><td>"+value+"</td></tr>");
					}else
					{
						e.find("td").eq(1).html(value); 
						//e.text(name+"="+value);
					}
					if(system==="P" && name=="Location")
					{
						if(!window.startLocation){
							//console.log(parts)
							var loc = value.split(",");
							viewer.camera.flyTo({
								destination : Cesium.Cartesian3.fromDegrees(parseFloat(loc[1]),parseFloat(loc[0]),1000.0)
							});
							window.startLocation=true
						}
						return;//dont display heatbeat in log.					
					}
				}
				if(evt.data.indexOf("P:")>0)//message from pc?
				{
					var parts = evt.data.split("P:")[1].split(" ")
					if(parts[0]==="screenshot")
					{
						var preview = document.getElementById("preview");
						preview.src = parts[1];//update screenshot.
						return;//dont display in log.
					}else if(parts[0]==="location")
					{
						if(!window.startLocation){
							console.log(parts)
							window.startLocation=parts
							viewer.camera.flyTo({
								destination : Cesium.Cartesian3.fromDegrees(parseFloat(parts[2]),parseFloat(parts[1]),1000.0)
							});
						}
						return;//dont display heatbeat in log.
					}else
					{
					}
				}
				if(evt.data.indexOf("F:")>0)//message from flightcontroller?
				{
					var parts = evt.data.split("F:")[1].split(":")
					if(parts[0]==="AircraftLocation")
					{
						//F:AircraftLocation:LocationCoordinate3D{latitude=47.76078060079433, longitude=-122.09482644836902, altitude=0.0}
						return;//dont display in log.
					}//else if(parts[0]==="location")
				}				
				
				//add to log window.
				 log.innerHTML = log.innerHTML+'<li class = "message">' + 
					evt.data.substring(9) + "</li>" ;//note substring cuts off date part of timestamp for brevity.
				log.scrollTop = log.scrollHeight;

               }
					
               function onError(evt) {
                  state.className = "fail";
                  state.innerHTML = "Communication error";
               }
					
               function addMessage() {
                  var message = chat.value;
                  chat.value = "";
                  websocket.send(message);
               }
					
            </script>
         </section>
		   <img id="preview" class="preview" src="/images/TestPattern.jpg">
		   <div id="status-panel"><table id="telemetry" ></table></div>
<img>
</body>
</html>

